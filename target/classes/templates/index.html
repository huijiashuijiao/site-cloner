<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>仿站工具</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}"/>
    <style>
        body { padding: 24px; }
        .container { max-width: 960px; }
        .card { box-shadow: 0 2px 8px rgba(0,0,0,.05); }
        .form-text { color:#6c757d; }
        .btn-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .rule-row { display:flex; gap:8px; margin-bottom:8px; }
        .rule-row input { flex:1; }
    </style>
    <!-- 回退：若无 webjars，本地样式也可省略 -->
</head>
<body>
<div class="container">
    <h1 class="mb-4">仿站下载</h1>
    <div class="card mb-3">
        <div class="card-body">
            <form method="post" th:action="@{/crawl}" th:object="${form}" onsubmit="return submitAsync(event)">
                <div class="mb-3">
                    <label class="form-label">起始 URL</label>
                    <input class="form-control" th:field="*{startUrl}" placeholder="https://example.com"/>
                    <div class="text-danger" th:if="${#fields.hasErrors('startUrl')}" th:errors="*{startUrl}"></div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" th:field="*{sameDomain}" id="sameDomain">
                    <label class="form-check-label" for="sameDomain">限制在同域</label>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">最大深度</label>
                        <input type="number" min="1" max="20" class="form-control" th:field="*{maxDepth}"/>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">最大页数</label>
                        <input type="number" min="1" max="10000" class="form-control" th:field="*{maxPages}"/>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">输出文件夹名（可选）</label>
                    <input class="form-control" th:field="*{outputName}" placeholder="my-site-copy"/>
                    <div class="form-text">默认：host-时间戳，输出根目录为应用运行目录下的 output/。</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">标题后缀</label>
                    <input class="form-control" th:field="*{titleSuffix}" placeholder="例如：凯发娱乐"/>
                    <div class="form-text">用于将每页标题改为“原标题-后缀”，并在 body 顶部插入 H1。</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Sitemap 域名</label>
                    <input class="form-control" th:field="*{sitemapDomain}" placeholder="例如：https://www.example.com"/>
                    <div class="form-text">生成 sitemap.xml 时作为 <loc> 的域名前缀，留空则使用起始域名。</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">文字替换规则（可添加多条）</label>
                    <div id="rules">
                        <div class="rule-row" th:each="r,i : *{replaceRules}">
                            <input class="form-control" th:field="*{replaceRules[__${i.index}__].find}" placeholder="原文字 例如：通知"/>
                            <input class="form-control" th:field="*{replaceRules[__${i.index}__].replaceWith}" placeholder="替换为 例如：娱乐城通知"/>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addRule()">新增一条规则</button>
                    <div class="form-text">按顺序对 HTML/JS/CSS 文本进行替换。</div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" th:field="*{debugOnlyHome}" id="debugOnlyHome">
                    <label class="form-check-label" for="debugOnlyHome">调试模式：只下载首页与首页资源</label>
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" type="submit">开始下载（异步）</button>
                    <a class="btn btn-outline-secondary" href="/tasks">内存任务列表</a>
                    <a class="btn btn-outline-secondary" href="/tasks/db">数据库任务列表</a>
                    <a class="btn btn-secondary" href="/debug/rewrite-js?file=test.js" target="_blank">调试JS替换（test.js → test2.js）</a>
                    <button class="btn btn-warning" type="button" onclick="submitMock(event)">提交模拟任务（20秒）</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
function addRule(){
    var container = document.getElementById('rules');
    var idx = container.children.length;
    var row = document.createElement('div');
    row.className = 'rule-row';
    row.innerHTML = '<input class="form-control" name="replaceRules['+idx+'].find" placeholder="原文字"/>'+
                    '<input class="form-control" name="replaceRules['+idx+'].replaceWith" placeholder="替换为"/>';
    container.appendChild(row);
}

function submitAsync(e){
  e.preventDefault();
  var obj = collectForm(e.target);
  fetch('/crawl/async', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj)})
    .then(function(r){return r.text();})
    .then(function(id){ alert('任务已提交，ID: '+id+'\n可在 数据库任务列表 页面查看。'); })
    .catch(function(err){ alert('提交失败: '+err); });
  return false;
}

function collectForm(form){
  var data = new FormData(form);
  var obj = {};
  data.forEach(function(v,k){
    if(k.endsWith(']')){
      var m = k.match(/^replaceRules\[(\d+)\]\.(find|replaceWith)$/);
      if(m){
        var i = m[1]; var f = m[2];
        obj.replaceRules = obj.replaceRules || [];
        obj.replaceRules[+i] = obj.replaceRules[+i] || {};
        obj.replaceRules[+i][f] = v;
        return;
      }
    }
    if(v === 'on') v = true;
    obj[k] = v;
  });
  return obj;
}

function submitMock(e){
  var form = document.querySelector('form');
  var obj = collectForm(form);
  var url = (obj.startUrl || '').toString().trim();
  if(!url){ alert('请先填写起始URL'); return; }
  fetch('/crawl/mock', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj)})
    .then(function(r){return r.text();})
    .then(function(id){ alert('模拟任务已提交，ID: '+id+'\n20秒后变为采集完成。\n可在 数据库任务列表 查看。'); })
    .catch(function(err){ alert('提交失败: '+err); });
}
</script>
</body>
</html>


