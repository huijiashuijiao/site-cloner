<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>采集任务（数据库）</title>
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.3/css/bootstrap.min.css" />
</head>
<body class="p-3">
<h3>采集任务（数据库）</h3>
<div class="mb-2">
    <a href="/" class="btn btn-secondary btn-sm">返回</a>
    <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">刷新</button>
</div>
<table class="table table-sm table-striped align-middle">
    <thead>
    <tr>
        <th>ID</th>
        <th>TaskUUID</th>
        <th>状态</th>
        <th>起始URL</th>
        <th>线程</th>
        <th>已下页数</th>
        <th>资产数</th>
        <th>错误</th>
        <th>开始时间</th>
        <th>结束时间</th>
        <th>输出目录</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="t : ${tasks}">
        <td th:text="${t.id}"></td>
        <td th:text="${t.taskUuid}"></td>
        <td th:text="${t.status}"></td>
        <td th:text="${t.startUrl}"></td>
        <td th:text="${t.threadName}"></td>
        <td th:text="${t.pagesDownloaded}"></td>
        <td th:text="${t.assetsDownloaded}"></td>
        <td><pre th:text="${t.errorsJson}" style="white-space: pre-wrap; margin:0"></pre></td>
        <td th:text="${t.startTime}"></td>
        <td th:text="${t.endTime}"></td>
        <td th:text="${t.outputDir}"></td>
        <td>
            <button class="btn btn-sm btn-outline-danger" th:attr="data-id=${t.taskUuid}" onclick="cancelTask(this)">取消</button>
        </td>
    </tr>
    </tbody>
</table>
<script>
function cancelTask(btn){
  var id = btn.getAttribute('data-id');
  if(!id) return;
  if(!confirm('确认取消任务: '+id+' ?')) return;
  fetch('/crawl/tasks/'+id+'/cancel', {method:'POST'})
    .then(function(r){return r.text();})
    .then(function(tx){ alert('取消结果: '+tx); location.reload(); })
    .catch(function(err){ alert('取消失败: '+err); });
}
</script>
</body>
</html>
